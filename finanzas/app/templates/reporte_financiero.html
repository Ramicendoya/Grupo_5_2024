{% extends 'base.html' %}
{% load static %}

{% block main %}
<div class="container mt-4">
    <div class="row">
        <!-- Título -->
        <div class="col-12 text-center">
            <p class="title" style="font-size: 24px; font-weight: bold;">Informe Financiero</p>
        </div>
        
        <!-- Selectores -->
        <div class="col-12 mt-2">
            <div class="d-flex justify-content-between align-items-center">          
                <!-- Selector de Gastos o Ingresos-->
                <div class="btn-group" role="group" aria-label="GastosIngresos">
                    <button type="button" class="btn btn-outline-secondary">Gastos</button>
                    <button type="button" class="btn btn-outline-secondary">Ingresos</button>
                </div>
                <!-- Selector de Mes o Año -->
                <div class="btn-group" role="group" aria-label="MesAño">
                    <button type="button" class="btn btn-outline-secondary">Mes</button>
                    <button type="button" class="btn btn-outline-secondary">Año</button>
                </div>
            </div>
        </div>

        <!-- Meses seleccionables -->
        <div class="col-12 mt-3">
            <div class="d-flex justify-content-between">
                <a href="#" class="text-dark">Enero</a>
                <a href="#" class="text-dark">Febrero</a>
                <a href="#" class="text-dark">Marzo</a>
                <a href="#" class="text-dark">Abril</a>
                <a href="#" class="text-dark">Mayo</a>
                <a href="#" class="text-dark">Junio</a>
                <a href="#" class="text-dark">Julio</a>
                <a href="#" class="text-dark">Agosto</a>
                <a href="#" class="text-dark">Septiembre</a>
                <a href="#" class="text-dark"><strong>Octubre</strong></a>
                <a href="#" class="text-dark">Noviembre</a>
                <a href="#" class="text-dark">Diciembre</a>
            </div>
        </div>

        <div class="col-12 d-flex mt-4">
            <!-- Gráfico de Google Charts -->
            <div id="google-chart-container" class="flex-fill" style="flex: 1;">
                <div id="google-piechart" style="width: 100%; height: 600px;"></div>
            </div>

            <!-- Detalle Categoria -->
            <div class="ml-4" id="detalle_categoria">
                <h5>Detalles de la Categoría</h5>
                <p>Aquí se mostrarán los detalles de la categoría seleccionada.</p>
            </div>
        </div>

        <!-- Leyenda personalizada -->
        <div class="ml-4 d-flex flex-column align-items-start" style="margin-left: 20px;">
            <span style="color: #FF6384;"><i class="bi bi-cart"></i> Compras</span>
            <span style="color: #36A2EB;"><i class="bi bi-cash-stack"></i> Deuda</span>
            <span style="color: #FFCE56;"><i class="bi bi-house"></i> Vivienda</span>
            <span style="color: #4BC0C0;"><i class="bi bi-scissors"></i> Belleza</span>
        </div>
    </div>
</div>

<style>
    #detalle_categoria {
        margin-top: 8%;
    }
</style>

<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

<script>
    var contexto = JSON.parse('{{ context|escapejs }}');
    var ingresos = contexto.ingresos;
    var gastos = contexto.gastos;
    var ingresosPorCategoria = contexto.ingresos_por_categoria; // Asegúrate de que coincida con el contexto

    console.log(contexto); // Verifica el contenido del contexto

    // Configuración del gráfico de Google Charts
    google.charts.load('current', {'packages':['corechart']});
    google.charts.setOnLoadCallback(drawChart);

    function drawChart() {
    var data = new google.visualization.DataTable();
    data.addColumn('string', 'Categoría');
    data.addColumn('number', 'Porcentaje');
    data.addColumn({type: 'string', role: 'tooltip', p: {'html': true}});

    // Verifica que ingresosPorCategoria no sea undefined y sea un array
    if (Array.isArray(ingresosPorCategoria)) {
        ingresosPorCategoria.forEach(function(item) {
            var tooltipContent = `
                <div>
                    <strong>Categoría: ${item.categoria__nombre}</strong><br>
                    Monto: $${item.total}<br>
                    Porcentaje: ${item.porcentaje.toFixed(2)}%
                </div>`;
            data.addRow([item.categoria__nombre, item.porcentaje, tooltipContent]);
        });
    } else {
        console.error("ingresosPorCategoria no es un array:", ingresosPorCategoria);
    }

    var options = {
        title: 'Distribución de Ingresos',
        pieSliceText: 'percentage',
        slices: {
            0: { color: '#FF6384' },
            1: { color: '#36A2EB' },
            2: { color: '#FFCE56' },
            3: { color: '#4BC0C0' }
        },
        legend: { position: 'right', alignment: 'center' },
        tooltip: { isHtml: true }
    };

    var chart = new google.visualization.PieChart(document.getElementById('google-piechart'));
    chart.draw(data, options);

    // Captura de clic en el gráfico o la leyenda
    google.visualization.events.addListener(chart, 'select', function() {
        var selectedItem = chart.getSelection()[0];
        if (selectedItem) {
            var category = data.getValue(selectedItem.row, 0); // Obtiene la categoría seleccionada
            var percentage = data.getValue(selectedItem.row, 1); // Obtiene el porcentaje
            var tooltipContent = data.getValue(selectedItem.row, 2); // Obtiene el monto (tooltip)

            // Extrae el monto desde el tooltipContent (por si quieres personalizarlo más)
            var monto = tooltipContent.match(/\$([0-9,]+)/)[0];

            // Actualiza el div de detalles con la información seleccionada
            document.getElementById('detalle_categoria').innerHTML = `
                <h5>Detalles de la Categoría</h5>
                <p><strong>Categoría:</strong> ${category}</p>
                <p><strong>Porcentaje:</strong> ${percentage.toFixed(2)}%</p>
                <p><strong>${monto}</strong></p>
            `;
        }
    });
}


</script>

{% endblock %}
