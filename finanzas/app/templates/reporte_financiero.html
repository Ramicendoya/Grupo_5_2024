{% extends 'base.html' %}
{% load static %}

{% block main %}
<div class="container mt-4">
    <div class="row">
        <!-- Título -->
        <div class="col-12 text-center">
            <p class="title" style="font-size: 24px; font-weight: bold;">Informe Financiero</p>
        </div>
        
        <!-- Selector de Gastos o Ingresos-->
        <div class="col-12 mt-2">
            <div class="d-flex align-items-center">   
                <h6>Seleccione que informe desea ver:</h6>
                <div class="btn-group selector" role="group" aria-label="GastosIngresos">
                    <button type="button" class="btn btn-outline-primary">Gastos</button>
                    <button type="button" class="btn btn-outline-primary">Ingresos</button>
                </div>
            </div>
        </div>

        <!-- Selector de Ciclo Mensual o Anual -->
        <div class="col-12 mt-2">
            <div class="d-flex align-items-center">
                <h6>Seleccione el ciclo:</h6>
                <div class="btn-group selector" role="group" aria-label="GastosIngresos">
                    <button type="button" class="btn btn-outline-primary" id="btn-mensual">Mensual</button>
                    <button type="button" class="btn btn-outline-primary" id="btn-anual">Anual</button>
                </div>
            </div>
        </div>

        <!-- Meses seleccionables -->
        <div class="btn-group mt-3" id="botones-meses" role="group" aria-label="Meses">
            <button type="button" class="btn btn-outline-primary">Enero</button>
            <button type="button" class="btn btn-outline-primary">Febrero</button>
            <button type="button" class="btn btn-outline-primary">Marzo</button>
            <button type="button" class="btn btn-outline-primary">Abril</button>
            <button type="button" class="btn btn-outline-primary">Mayo</button>
            <button type="button" class="btn btn-outline-primary">Junio</button>
            <button type="button" class="btn btn-outline-primary">Julio</button>
            <button type="button" class="btn btn-outline-primary">Agosto</button>
            <button type="button" class="btn btn-outline-primary">Septiembre</button>
            <button type="button" class="btn btn-outline-primary">Octubre</button>
            <button type="button" class="btn btn-outline-primary">Noviembre</button>
            <button type="button" class="btn btn-outline-primary">Diciembre</button>
        </div>

        
        <div class="col-12 d-flex mt-4">
            <!-- Gráfico de Google Charts -->
            <div id="google-chart-container" class="flex-fill" style="flex: 1;">
                <div id="google-piechart" style="width: 100%; height: 600px;"></div>
            </div>
        
            <!-- Detalle Categoria -->
            <div class="ml-4" id="detalle_categoria">
                <h5>Detalles de la Categoría</h5>
                <p>Selecciona una categoria para ver sus detalles.</p>
            </div>
            
            <div class="alert alert-warning" role="alert" id="mensaje-ingresos">
                No hay ingresos registrados para este mes.
            </div>
        </div>

        <!-- Leyenda del gráfico -->
        <div class="ml-4 d-flex flex-column align-items-start" style="margin-left: 20px;">
            <span style="color: #FF6384;"><i class="bi bi-cart"></i> Compras</span>
            <span style="color: #36A2EB;"><i class="bi bi-cash-stack"></i> Deuda</span>
            <span style="color: #FFCE56;"><i class="bi bi-house"></i> Vivienda</span>
            <span style="color: #4BC0C0;"><i class="bi bi-scissors"></i> Belleza</span>
        </div>
    </div>
</div>

<style>
    #detalle_categoria {
        margin-top: 8%;
    }
    .active {
    background-color: #007bff;
    color: white; /
    }

    .ciclo{
        margin-left: 4%;
    }

    .selector{
        margin-left: 2%;
    }
    .btn.selected {
        background-color: #007bff; 
        color: white;
    }
    .btn.disabled {
    pointer-events: none; /* Desactiva los clicks */
    opacity: 0.5;
}
</style>

<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

<script>
    var contexto = JSON.parse('{{ context|escapejs }}');
    var ingresos = contexto.ingresos;
    var gastos = contexto.gastos;
    var ingresosPorCategoria = contexto.ingresos_por_categoria;


    // Configuración del gráfico de Google Charts
    google.charts.load('current', {'packages':['corechart']});
    google.charts.setOnLoadCallback(drawChart);

    function drawChart() {
    var data = new google.visualization.DataTable();
    data.addColumn('string', 'Categoría');
    data.addColumn('number', 'Porcentaje');
    data.addColumn({type: 'string', role: 'tooltip', p: {'html': true}});

    // Verifica que ingresosPorCategoria no sea undefined y sea un array
    if (Array.isArray(ingresosPorCategoria)) {
        ingresosPorCategoria.forEach(function(item) {
            var tooltipContent = `
                <div>
                    <strong>Categoría: ${item.categoria__nombre}</strong><br>
                    Monto: $${item.total}<br>
                    Porcentaje: ${item.porcentaje.toFixed(2)}%
                </div>`;
            data.addRow([item.categoria__nombre, item.porcentaje, tooltipContent]);
        });
    } else {
        console.error("ingresosPorCategoria no es un array:", ingresosPorCategoria);
    }

    var options = {
        title: 'Distribución de Ingresos',
        pieSliceText: 'percentage',
        slices: {
            0: { color: '#FF6384' },
            1: { color: '#36A2EB' },
            2: { color: '#FFCE56' },
            3: { color: '#4BC0C0' }
        },
        legend: { position: 'right', alignment: 'center' },
        tooltip: { isHtml: true }
    };

    var chart = new google.visualization.PieChart(document.getElementById('google-piechart'));
    chart.draw(data, options);

    // Captura de clic en el gráfico o la leyenda
    google.visualization.events.addListener(chart, 'select', function() {
        var selectedItem = chart.getSelection()[0];
        if (selectedItem) {
            var category = data.getValue(selectedItem.row, 0); // Obtiene la categoría seleccionada
            var percentage = data.getValue(selectedItem.row, 1); // Obtiene el porcentaje
            var tooltipContent = data.getValue(selectedItem.row, 2); // Obtiene el monto (tooltip)

            // Extrae el monto desde el tooltipContent
            var monto = tooltipContent.match(/\$([0-9,]+)/)[0];

            // Actualiza el div de detalles con la información seleccionada
            document.getElementById('detalle_categoria').innerHTML = `
                <h5>Detalles de la Categoría</h5>
                <p><strong>Categoría:</strong> ${category}</p>
                <p><strong>Porcentaje:</strong> ${percentage.toFixed(2)}%</p>
                <p><strong>Monto:</strong> ${monto}</p>
            `;
        }
    });
}

// Captura todos los botones de los meses
const botonesMeses = document.querySelectorAll('#botones-meses .btn');

// Mapea los nombres de los meses a sus valores numéricos (1 - Enero, 12 - Diciembre)
const meses = {
    'Enero': 1,
    'Febrero': 2,
    'Marzo': 3,
    'Abril': 4,
    'Mayo': 5,
    'Junio': 6,
    'Julio': 7,
    'Agosto': 8,
    'Septiembre': 9,
    'Octubre': 10,
    'Noviembre': 11,
    'Diciembre': 12
};

// Obtiene el mes desde la URL
const urlParts = window.location.pathname.split('/');
const mesUrl = parseInt(urlParts[urlParts.length - 2]);


// Establece el botón activo según el mes en la URL
if (mesUrl) {
    const mesSeleccionado = Object.keys(meses).find(mes => meses[mes] === mesUrl);
    if (mesSeleccionado) {
        const botonActivo = Array.from(botonesMeses).find(btn => btn.textContent.trim() === mesSeleccionado);
        if (botonActivo) {
            botonActivo.classList.add('active');
        }
    }
}

// Itera sobre cada botón de mes y añade un evento para capturar el clic
botonesMeses.forEach(boton => {
    boton.addEventListener('click', function(event) {
        event.preventDefault();
        const mesSeleccionado = this.textContent.trim();  // Captura el texto del mes
        const mesNumerico = meses[mesSeleccionado];  // Obtén el valor numérico del mes

        if (mesNumerico) {
            // Obtiene el año actual
            const anioActual = new Date().getFullYear();
            // Redirige a la URL 
            const url = `/ver/reporteFinanciero/${anioActual}/${mesNumerico}/`;
            window.location.href = url;  // Redirige a la nueva URL
        }
    });
});

// Comprobar si hay ingresos
var contexto = JSON.parse('{{ context|escapejs }}');
var hayIngresos = contexto.hay_ingresos;

// Lógica para mostrar/ocultar elementos
if (hayIngresos) {
    document.getElementById('google-chart-container').style.display = 'block';
    document.getElementById('detalle_categoria').style.display = 'block'; // Mostrar detalle si hay ingresos
    document.getElementById('mensaje-ingresos').style.display = 'none';  // Ocultar mensaje si hay ingresos
} else {
    document.getElementById('google-chart-container').style.display = 'none';  // Ocultar gráfico si no hay ingresos
    document.getElementById('detalle_categoria').style.display = 'none'; // Ocultar detalle si no hay ingresos
    document.getElementById('mensaje-ingresos').style.display = 'block';  // Mostrar mensaje
}


// Captura de los botones de Gastos e Ingresos
const botonesGastosIngresos = document.querySelectorAll('.btn-group.selector button');

// Itera sobre cada botón y añade un evento para capturar el clic
botonesGastosIngresos.forEach(boton => {
    boton.addEventListener('click', function() {
        // Elimina la clase 'selected' de todos los botones
        botonesGastosIngresos.forEach(btn => btn.classList.remove('selected'));
        
        // Agrega la clase 'selected' al botón que fue clickeado
        this.classList.add('selected');
    });
});

// Captura de los botones de Ciclo (Mensual y Anual)
const botonesCiclo = document.querySelectorAll('.btn-group.selector + .btn-group button');

// Itera sobre cada botón y añade un evento para capturar el click
botonesCiclo.forEach(boton => {
    boton.addEventListener('click', function() {
        // Elimina la clase 'selected' de todos los botones
        botonesCiclo.forEach(btn => btn.classList.remove('selected'));
        
        // Agrega la clase 'selected' al botón que fue clickeado
        this.classList.add('selected');
    });
});


// Captura de los botones de ciclo
const btnMensual = document.getElementById('btn-mensual');
const btnAnual = document.getElementById('btn-anual');

// Función para activar/desactivar botones de meses
function toggleMonthButtons(isAnnual) {
    botonesMeses.forEach(button => {
        button.disabled = isAnnual; // Bloquea los botones si es anual
        button.classList.toggle('disabled', isAnnual); // Agrega clase para deshabilitar estilos
    });
}

// Evento para los botones de ciclo
btnMensual.addEventListener('click', function() {
    toggleMonthButtons(false); // Activa los botones de meses
});

btnAnual.addEventListener('click', function() {
    btnMensual.classList.remove('active') // saco clase active del boton mensual
    toggleMonthButtons(true); // Desactiva los botones de meses
    const anioActual = new Date().getFullYear();
    const url = `/ver/reporteFinanciero/${anioActual}/0/`;
            window.location.href = url;  // Redirige a la nueva URL
});
</script>

{% endblock %}
